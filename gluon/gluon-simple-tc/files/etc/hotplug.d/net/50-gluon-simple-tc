[ "$ACTION" = 'add' ] || exit 0

config_load gluon-simple-tc


tc_interface() {
	local iface="$1"

	config_get ifname "$iface" ifname

	[ "$INTERFACE" = "$ifname" ] || return

	config_get_bool enabled "$iface" enabled 0

	[ "$enabled" -eq 1 ] || return

	config_get limit_ingress "$iface" limit_ingress
	config_get limit_egress "$iface" limit_egress
	config_get autotest "$iface" autotest

	# Limits per % -> Langzeitmessung im Hintergrund
	if [ 0$autotest -eq 1 ] ; then
		echo "$0 autotest allowed in uci / site.conf " >>/tmp/auto-tc-output
		if [ "0$limit_ingress" -lt 100 ] || [ "0$limit_egress" -lt 100 ] ; then
			echo "autotest needed (wert <100) " >>/tmp/auto-tc-output
			/lib/gluon/auto-tc/check-and-update.lua >>/tmp/auto-tc-output &
			# Minimalfallback fÃ¼r den Fall, das die Messungen schief gehen
			[ "$limit_ingress" ] && [ "0$limit_ingress" -lt 100 ] && limit_ingress=400
			[ "$limit_egress" ]  && [ "0$limit_egress" -lt 100 ]  && limit_egress=100
		fi
	fi

	[ "$limit_ingress" ] || limit_ingress=-
	[ "$limit_egress" ] || limit_egress=-

	gluon-simple-tc "$INTERFACE" "$limit_ingress" "$limit_egress"
}

config_foreach tc_interface 'interface'
